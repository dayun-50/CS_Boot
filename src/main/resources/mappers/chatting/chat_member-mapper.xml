<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- 채팅 참여자 -->
  
  <mapper namespace="Chat_member">
  	
  	 <select id="checkPrivateChat" resultType="int">
		SELECT cm.chat_seq
		FROM chat_member cm
		JOIN chat_room cr ON cm.chat_seq = cr.chat_seq
		WHERE cr.chat_name != #{depChatName}
		GROUP BY cm.chat_seq
		HAVING COUNT(DISTINCT cm.member_email) = 2
		   AND SUM(CASE WHEN cm.member_email = #{email1} THEN 1 ELSE 0 END) = 1
		   AND SUM(CASE WHEN cm.member_email = #{email2} THEN 1 ELSE 0 END) = 1
	 </select>
	 
	 <insert id="insertChat">
	 	insert into chat_member values (#{chat_seq}, #{member_email}, #{role}, 0)
	 </insert>
	 
	 <select id="existDepartmentRoom" resultType="int">
	 	select count(*) from chat_member where chat_seq = #{chat_seq} and member_email = #{email}
	 </select>
	 
	 <select id="countMember" resultType="int">
	 	select count(*) from chat_member where chat_seq = #{chat_seq}
	 </select>
	 
	<update id="updateLastMessageSeq">
		update chat_member set last_message_seq = #{last_message_seq} where chat_seq = #{chat_seq} and member_email = #{member_email}
	</update>
	
	<select id="selectMember" resultType="String">
		select member_email from chat_member where chat_seq = #{chat_seq}
	</select>
	
	<select id="getLastMessageSeq" resultType="int">
  		select last_message_seq from chat_member where member_email = #{member_email} and chat_seq = #{chat_seq}
  	</select>
  	
  	<delete id="outChat">
  		delete from chat_member where chat_seq = #{chat_seq} and member_email = #{member_email}
  	</delete>	
	
	  	
  </mapper>